#!/bin/bash
# vivado-fpga-tool - Vivado FPGA SPI Flash Tool
# Main entry point script

set -e  # Exit on error
set -o pipefail  # Pipe failures propagate

# Version information (substituted by CMake)
readonly VERSION="@PROJECT_VERSION@"
readonly INSTALL_SHARE_DIR="@INSTALL_SHARE_DIR@"
readonly INSTALL_VIVADO_PATH="@VIVADO_PATH@"

# Resolve dependencies directory
resolve_depends_dir() {
    local depends_dir=""

    if [[ -n "${OPT_DEPENDS:-}" ]]; then
        depends_dir="$OPT_DEPENDS"
    elif [[ -n "${VIVADO_FPGA_TOOL_HOME:-}" ]]; then
        depends_dir="$VIVADO_FPGA_TOOL_HOME"
    elif [[ -n "${INSTALL_SHARE_DIR:-}" ]] && [[ "$INSTALL_SHARE_DIR" != "@"*"@" ]]; then
        # CMake-configured path (check it's not a placeholder)
        depends_dir="$INSTALL_SHARE_DIR"
    else
        # Portable mode: auto-detect from script location
        local script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        depends_dir="$script_dir"
    fi

    # Validate dependency directory
    if [[ ! -d "$depends_dir/lib" ]]; then
        echo "ERROR: Invalid dependency directory: $depends_dir" >&2
        echo "Expected to find: $depends_dir/lib/" >&2
        exit 1
    fi

    echo "$depends_dir"
}

# Initialize environment
DEPENDS_DIR=$(resolve_depends_dir)
LIB_DIR="${DEPENDS_DIR}/lib"
BOARD_DIR="${DEPENDS_DIR}/boards"
TEMPLATE_DIR="${DEPENDS_DIR}/tcl-templates"

# Source library files
# shellcheck disable=SC1090,SC1091
source "${LIB_DIR}/common.sh" || { echo "ERROR: Failed to load common.sh" >&2; exit 1; }
# shellcheck disable=SC1090,SC1091
source "${LIB_DIR}/platform.sh" || die "Failed to load platform.sh" 1
# shellcheck disable=SC1090,SC1091
source "${LIB_DIR}/board.sh" || die "Failed to load board.sh" 1
# shellcheck disable=SC1090,SC1091
source "${LIB_DIR}/vivado.sh" || die "Failed to load vivado.sh" 1
# shellcheck disable=SC1090,SC1091
source "${LIB_DIR}/tcl.sh" || die "Failed to load tcl.sh" 1

# Global options (set by argument parser)
OPT_BOARD=""
OPT_VIVADO=""
OPT_DEPENDS=""
OPT_PLATFORM=""
OPT_FORMAT="human"
OPT_LOG=""
VERBOSE=0
QUIET=0

# Command to execute
COMMAND=""

# Parse command line arguments
parse_arguments() {
    [[ $# -eq 0 ]] && { show_usage; exit 0; }

    # First argument is the command
    COMMAND="$1"
    shift

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --board=*)
                OPT_BOARD="${1#*=}"
                shift
                ;;
            --vivado=*)
                OPT_VIVADO="${1#*=}"
                shift
                ;;
            --depends=*)
                OPT_DEPENDS="${1#*=}"
                shift
                ;;
            --platform=*)
                OPT_PLATFORM="${1#*=}"
                shift
                ;;
            --format=*)
                OPT_FORMAT="${1#*=}"
                shift
                ;;
            --log=*)
                OPT_LOG="${1#*=}"
                shift
                ;;
            --verbose|-v)
                VERBOSE=1
                shift
                ;;
            --quiet|-q)
                QUIET=1
                shift
                ;;
            --help|-h)
                show_usage
                exit 0
                ;;
            --version)
                echo "vivado-fpga-tool version ${VERSION}"
                exit 0
                ;;
            *)
                die "Unknown option: $1\n\nUse --help for usage information." "$EXIT_INVALID_ARGS"
                ;;
        esac
    done

    # Export options for library functions
    export OPT_BOARD OPT_VIVADO OPT_DEPENDS OPT_PLATFORM
    export OUTPUT_FORMAT="$OPT_FORMAT"
    export VERBOSE QUIET
}

# Command: info - Display FPGA and flash information
cmd_info() {
    log_stage 1 "Connecting to FPGA"

    # Validate required options
    [[ -z "$OPT_BOARD" ]] && die "Missing required option: --board=<name>" "$EXIT_INVALID_ARGS"

    # Load board configuration
    load_board_config "$OPT_BOARD"

    # Find Vivado
    find_vivado_path

    # Check USB attachment (WSL2 only)
    if ! check_usb_attachment; then
        die "USB JTAG device attached to WSL2. Please detach it first." "$EXIT_PLATFORM_ERROR"
    fi

    # Create temporary directory for TCL script
    local temp_dir=$(create_temp_dir)
    trap cleanup_temp_files EXIT

    # Generate TCL script
    log_stage 2 "Generating TCL script"
    local tcl_script="${temp_dir}/info.tcl"
    generate_info_tcl "$tcl_script"

    # Execute Vivado
    log_stage 3 "Executing Vivado Hardware Manager"
    log_info "This may take a few moments..."

    if ! execute_vivado "$tcl_script" "$LOG_FILE"; then
        log_status "FAILURE"
        die "Failed to detect FPGA/Flash" "$EXIT_FPGA_CONNECT_FAILED"
    fi

    log_status "SUCCESS"
    return 0
}

# Main execution
main() {
    # Parse arguments
    parse_arguments "$@"

    # Detect platform (can be overridden by --platform)
    if [[ -n "$OPT_PLATFORM" ]]; then
        PLATFORM="$OPT_PLATFORM"
        case "$PLATFORM" in
            wsl2)
                IS_WSL2=1
                IS_LINUX=0
                IS_WINDOWS=0
                ;;
            linux)
                IS_WSL2=0
                IS_LINUX=1
                IS_WINDOWS=0
                ;;
            windows)
                IS_WSL2=0
                IS_LINUX=0
                IS_WINDOWS=1
                ;;
            *)
                die "Invalid platform: $OPT_PLATFORM (valid: wsl2, linux, windows)" "$EXIT_PLATFORM_ERROR"
                ;;
        esac
        log_debug "Platform overridden: $PLATFORM"
    else
        detect_platform
    fi

    # Initialize logging
    if [[ -n "$OPT_LOG" ]]; then
        LOG_FILE="$OPT_LOG"
        mkdir -p "$(dirname "$LOG_FILE")" 2>/dev/null || die "Cannot create log directory: $(dirname "$LOG_FILE")" "$EXIT_FILE_IO_ERROR"
        touch "$LOG_FILE" || die "Cannot create log file: $LOG_FILE" "$EXIT_FILE_IO_ERROR"
        log_debug "Custom log file: $LOG_FILE"
    else
        init_log_file "$COMMAND"
    fi

    log_debug "========================================"
    log_debug "vivado-fpga-tool v${VERSION}"
    log_debug "Command: $COMMAND"
    log_debug "Platform: $PLATFORM"
    log_debug "Depends: $DEPENDS_DIR"
    log_debug "========================================"

    # Execute command
    case "$COMMAND" in
        info)
            cmd_info
            ;;
        flash|dump|verify)
            die "Command '$COMMAND' not yet implemented. Coming soon!" "$EXIT_INVALID_ARGS"
            ;;
        *)
            die "Unknown command: $COMMAND\n\nUse --help for usage information." "$EXIT_INVALID_ARGS"
            ;;
    esac

    log_debug "Command completed successfully"
    [[ -n "$LOG_FILE" ]] && log_info "Log file: $LOG_FILE"
}

# Run main function
main "$@"
